name: ğŸ–¥ï¸ Free RDP via Cloudflare Tunnel (No Ngrok)

on: [workflow_dispatch]

jobs:
  rdp:
    runs-on: windows-latest

    steps:
    - name: ğŸ” Create RDP User
      run: |
        $username = "runneradmin"
        $password = "MyPass12345"
        
        # Check if user exists
        $userExists = net user $username | Out-Null; if ($LASTEXITCODE -eq 0) { $true } else { $false }

        if (-not $userExists) {
          net user $username $password /add
        } else {
          Write-Host "â„¹ï¸ User $username already exists"
          net user $username $password  # Reset password
        }

        # Add to Administrators group if not already
        net localgroup administrators | findstr /C:"$username"
        if ($LASTEXITCODE -ne 0) {
          net localgroup administrators $username /add
        } else {
          Write-Host "â„¹ï¸ $username is already in administrators group"
        }

    - name: âœ… Enable RDP and Allow Firewall
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Write-Host "âœ… RDP enabled and firewall allowed."

    - name: ğŸ“¦ Install Cloudflared
      run: |
        Invoke-WebRequest -Uri https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile cloudflared.exe
        Move-Item cloudflared.exe C:\Windows\System32\cloudflared.exe
        Write-Host "âœ… Cloudflared installed"

    - name: ğŸŒ Start Tunnel to RDP (3389)
      run: |
        Start-Process -WindowStyle Hidden -FilePath cloudflared.exe -ArgumentList 'tunnel', '--url', 'rdp://localhost:3389'
        Start-Sleep -Seconds 15

    - name: ğŸ–¥ï¸ Tunnel Info (Manual Copy)
      run: |
        Write-Host "ğŸ”’ Cloudflare tunnel running."
        Write-Host "â³ Wait ~20s then open the runner logs to find the *.trycloudflare.com URL in logs."
        Write-Host "ğŸ§‘â€ğŸ’» Connect with:"
        Write-Host "  â¤ User: runneradmin"
        Write-Host "  â¤ Pass: MyPass12345"

    - name: ğŸ•’ Keep Alive (6 Hours)
      run: |
        Write-Host "ğŸŸ¢ RDP session ready for up to 6 hours..."
        Start-Sleep -Seconds 21600
