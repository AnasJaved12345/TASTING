name: RDP

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: ‚úÖ Setup RDP User
      shell: powershell
      run: |
        $username = "runneradmin"
        $password = "MyPass12345"

        # Check if user exists
        $userExists = net user $username 2>$null
        if (-not $userExists) {
          net user $username $password /add /y | Out-Null
        } else {
          Write-Host "‚ÑπÔ∏è User $username already exists."
        }

        # Check if user is in Administrators group
        $isInGroup = net localgroup administrators | Select-String -Pattern $username
        if (-not $isInGroup) {
          net localgroup administrators $username /add | Out-Null
        } else {
          Write-Host "‚ÑπÔ∏è $username already in Administrators group."
        }

        exit 0

    - name: ‚úÖ Enable RDP and Firewall
      shell: powershell
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Write-Host "‚úÖ RDP enabled and firewall allowed."

    - name: ‚úÖ Download and Start Cloudflared Tunnel
      shell: powershell
      run: |
        Invoke-WebRequest -Uri https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile cloudflared.exe
        Start-Process -WindowStyle Hidden -FilePath cloudflared.exe -ArgumentList 'tunnel', '--url', 'rdp://localhost:3389'
        Start-Sleep -Seconds 20

    - name: üîç Show Cloudflared Tunnel URL
      shell: powershell
      run: |
        $logs = Get-ChildItem "$env:USERPROFILE\.cloudflared\logs\" -Filter *.log -Recurse -ErrorAction SilentlyContinue |
                Sort-Object LastWriteTime -Descending |
                Select-Object -First 1 |
                Get-Content |
                Select-String -Pattern "trycloudflare.com" |
                Select-Object -Last 1

        if ($logs) {
          Write-Host "üîó RDP Tunnel URL: $($logs.Line)"
        } else {
          Write-Host "‚ö†Ô∏è Could not auto-detect the tunnel URL. Please open runner logs manually."
        }

    - name: ‚ÑπÔ∏è Show Login Info
      run: |
        Write-Host "üßë‚Äçüíª Connect using:"
        Write-Host "  ‚û§ User: runneradmin"
        Write-Host "  ‚û§ Pass: MyPass12345"
        Write-Host "  ‚è≥ Tunnel will remain active for up to 6 hours"
