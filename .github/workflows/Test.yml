name: ğŸ–¥ï¸ Free RDP via Cloudflare Tunnel

on: [workflow_dispatch]

jobs:
  free-rdp:
    runs-on: windows-latest

    steps:
    - name: ğŸ§¾ Set RDP Password
      run: |
        net user runneradmin "MySecurePassword123!" /add
        net localgroup administrators runneradmin /add
        Write-Host "âœ… User runneradmin created with password."

    - name: ğŸ” Enable RDP and Firewall
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Write-Host "âœ… RDP Enabled and firewall rule applied."

    - name: ğŸ“¦ Install Cloudflare Tunnel
      run: |
        Invoke-WebRequest -Uri https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile cloudflared.exe
        Move-Item cloudflared.exe C:\Windows\System32\cloudflared.exe
        Write-Host "âœ… Cloudflared installed."

    - name: ğŸš‡ Start Cloudflare Tunnel to RDP (port 3389)
      run: |
        Start-Process -NoNewWindow -FilePath "cloudflared.exe" -ArgumentList 'tunnel', '--url', 'rdp://localhost:3389'
        Start-Sleep -Seconds 15
        Write-Host "âœ… Tunnel started in background."

    - name: ğŸŒ Get Public RDP Tunnel URL
      run: |
        $url = ""
        for ($i=0; $i -lt 30; $i++) {
            $tunnelLogs = Get-Content "$env:USERPROFILE\.cloudflared\*.log" -ErrorAction SilentlyContinue
            if ($tunnelLogs -match "trycloudflare.com") {
                $url = ($tunnelLogs | Select-String -Pattern "trycloudflare.com" | Select-Object -Last 1).Line
                break
            }
            Start-Sleep -Seconds 2
        }
        if ($url -eq "") {
            Write-Host "âŒ Could not retrieve Cloudflare URL."
        } else {
            Write-Host "âœ… Your RDP is available at this Cloudflare URL:"
            Write-Host "ğŸ”— $url"
            Write-Host "ğŸ–¥ï¸ Connect using:"
            Write-Host "  â¤ Username: runneradmin"
            Write-Host "  â¤ Password: MySecurePassword123!"
        }

    - name: ğŸ•’ Keep the session alive for 6 hours
      run: |
        Write-Host "ğŸŸ¢ Keeping runner alive for 6 hours..."
        Start-Sleep -Seconds 21600
