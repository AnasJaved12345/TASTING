name: RDP

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest

    steps:
    - name: âœ… Setup Variables
      shell: powershell
      run: |
        $username = "runneradmin"
        $password = "MyPass12345"

        # Create user if not exists
        net user $username $password /add | Out-Null
        net localgroup administrators $username /add | Out-Null
        Write-Host "$username is already in administrators group"

    - name: âœ… Enable RDP & Allow Firewall
      shell: powershell
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

    - name: ğŸ“¦ Download Cloudflared
      shell: powershell
      run: |
        Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "cloudflared.exe"

    - name: ğŸš€ Start Cloudflare Tunnel (background)
      shell: powershell
      run: |
        Start-Process -FilePath ".\cloudflared.exe" -ArgumentList "tunnel", "--url", "rdp://localhost:3389", "--logfile", "cloudflared.log", "--loglevel", "info"
        Start-Sleep -Seconds 20

    - name: ğŸŒ Extract and Print Tunnel URL
      shell: powershell
      run: |
        $logPath = "cloudflared.log"
        $maxTries = 10
        $success = $false

        for ($i = 0; $i -lt $maxTries; $i++) {
          if (Test-Path $logPath) {
            $url = Get-Content $logPath | Select-String -Pattern "trycloudflare.com" | Select-Object -Last 1
            if ($url) {
              Write-Host "`nğŸŒ RDP Tunnel URL:"
              Write-Host "ğŸ‘‰ $($url.Line)"
              $success = $true
              break
            }
          }
          Start-Sleep -Seconds 3
        }

        if (-not $success) {
          Write-Host "âŒ Could not find Cloudflare tunnel URL."
        }

    - name: ğŸ§‘â€ğŸ’» RDP Credentials
      shell: powershell
      run: |
        Write-Host "`nğŸŸ¢ RDP session ready!"
        Write-Host "ğŸ‘‰ Connect using:"
        Write-Host "   â¤ Username: runneradmin"
        Write-Host "   â¤ Password: MyPass12345"
