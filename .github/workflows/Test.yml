name: ğŸš€ Ultimate Windows RDP via Ngrok (6 Hours, Admin Access)

on:
  workflow_dispatch:

jobs:
  RDP-Setup:
    runs-on: windows-latest
    timeout-minutes: 360  # Max GitHub Actions runtime

    steps:
    - name: ğŸ§¼ Enable RDP, Create Admin User, Configure Firewall
      shell: pwsh
      run: |
        Write-Host "ğŸ”§ Enabling Remote Desktop Protocol..."
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Write-Host "âœ… RDP and firewall configured."

        Write-Host "ğŸ” Ensuring 'runneradmin' exists..."
        if (-not (Get-LocalUser -Name "runneradmin" -ErrorAction SilentlyContinue)) {
          net user runneradmin P@ssw0rd123 /add
          Write-Host "âœ… User created."
        } else {
          Write-Host "â„¹ï¸ User already exists."
        }

        Write-Host "ğŸ›¡ï¸ Adding 'runneradmin' to Administrators group..."
        $group = [ADSI]"WinNT://./Administrators,group"
        $memberPath = "WinNT://./runneradmin,user"
        $alreadyMember = $false
        foreach ($member in @($group.psbase.Invoke("Members"))) {
          if ($member.GetType().InvokeMember("Name", 'GetProperty', $null, $member, $null) -eq "runneradmin") {
            $alreadyMember = $true
            break
          }
        }
        if (-not $alreadyMember) {
          $group.Add($memberPath)
          Write-Host "âœ… 'runneradmin' added to Administrators."
        } else {
          Write-Host "â„¹ï¸ Already an admin."
        }

        Write-Host "ğŸ User fully configured."

    - name: ğŸ› ï¸ Download & Extract Ngrok
      shell: pwsh
      run: |
        $ngrokPath = "$env:USERPROFILE\ngrok"
        if (-not (Test-Path "$ngrokPath\ngrok.exe")) {
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-windows-amd64.zip" -OutFile "$env:USERPROFILE\ngrok.zip"
          Expand-Archive "$env:USERPROFILE\ngrok.zip" -DestinationPath "$ngrokPath"
          Write-Host "âœ… Ngrok downloaded and extracted."
        } else {
          Write-Host "â„¹ï¸ Ngrok already present."
        }

    - name: ğŸ” Authenticate Ngrok Token
      shell: pwsh
      run: |
        & "$env:USERPROFILE\ngrok\ngrok.exe" authtoken "${{ secrets.NGROK_AUTH_TOKEN }}"
        Write-Host "âœ… Ngrok authtoken applied."

    - name: ğŸšª Start Ngrok TCP Tunnel (Port 3389)
      shell: pwsh
      run: |
        Start-Process -NoNewWindow -FilePath "$env:USERPROFILE\ngrok\ngrok.exe" -ArgumentList "tcp 3389"
        Start-Sleep -Seconds 10
        Write-Host "âœ… Ngrok tunnel started."

    - name: ğŸŒ Retrieve Ngrok Public RDP Address (with retry)
      id: ngrok
      shell: pwsh
      run: |
        $maxRetries = 30
        $retryDelay = 5
        $addr = $null

        for ($i = 0; $i -lt $maxRetries; $i++) {
          try {
            $response = Invoke-RestMethod -Uri "http://127.0.0.1:4040/api/tunnels"
            $addr = $response.tunnels[0].public_url -replace "tcp://", ""
            echo "::set-output name=rdp::$addr"
            Write-Host "âœ… Ngrok tunnel is ready: $addr"
            break
          } catch {
            Write-Host "â³ Attempt $($i+1)/$maxRetries: Ngrok not ready. Retrying in $retryDelay seconds..."
            Start-Sleep -Seconds $retryDelay
          }
        }

        if (-not $addr) {
          throw "âŒ Ngrok tunnel did not initialize in time."
        }

    - name: ğŸ–¥ï¸ Display RDP Credentials
      shell: pwsh
      run: |
        Write-Host "ğŸ“¡ RDP Address: ${{ steps.ngrok.outputs.rdp }}"
        Write-Host "ğŸ‘¤ Username: runneradmin"
        Write-Host "ğŸ” Password: P@ssw0rd123"
        Write-Host "âš ï¸ Please connect within a few minutes to avoid session timeout."

    - name: ğŸ§© (Optional) Install Extra Software
      shell: pwsh
      run: |
        # Uncomment below to install Chrome or VS Code if needed
        # iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
        # choco install googlechrome -y
        # choco install vscode -y
        Write-Host "ğŸ§© Custom software installation placeholder (optional)."

    - name: ğŸ§  Prevent Idle Timeout (6 Hours)
      shell: pwsh
      run: |
        for ($i = 0; $i -lt 360; $i++) {
          Write-Host "ğŸ•’ Runner active: $i minutes elapsed."
          Start-Sleep -Seconds 60
        }
