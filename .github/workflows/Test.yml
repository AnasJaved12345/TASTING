name: ğŸš€ Windows 11 RDP via Ngrok

on:
  workflow_dispatch:

jobs:
  RDP-Setup:
    runs-on: windows-latest
    timeout-minutes: 360  # Max 6 hours
    steps:
    - name: ğŸ§¼ Prep - Enable RDP & Firewall
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        net user runneradmin P@ssw0rd123 /add
        net localgroup administrators runneradmin /add
        echo "âœ… RDP Enabled and user created."

    - name: ğŸ› ï¸ Install Ngrok
      run: |
        Invoke-WebRequest -Uri https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-windows-amd64.zip -OutFile ngrok.zip
        Expand-Archive ngrok.zip -DestinationPath $env:USERPROFILE\ngrok
        echo "âœ… Ngrok installed."

    - name: ğŸ” Setup Ngrok Auth Token
      run: |
        $ngrok_token = "${{ secrets.NGROK_AUTH_TOKEN }}"
        $env:NGROK_AUTHTOKEN = $ngrok_token
        & "$env:USERPROFILE\ngrok\ngrok.exe" authtoken $ngrok_token

    - name: ğŸšª Start Ngrok TCP Tunnel (RDP 3389)
      run: |
        Start-Process -NoNewWindow -FilePath "$env:USERPROFILE\ngrok\ngrok.exe" -ArgumentList "tcp 3389"
        Start-Sleep -Seconds 10
        echo "âœ… Ngrok tunnel launched."

    - name: ğŸŒ Fetch Public RDP Address
      id: ngrok
      shell: pwsh
      run: |
        $ngrok_tunnel_info = Invoke-RestMethod -Uri http://localhost:4040/api/tunnels
        $rdp_addr = $ngrok_tunnel_info.tunnels[0].public_url -replace "tcp://", ""
        echo "::set-output name=rdp::$rdp_addr"

    - name: ğŸ–¥ï¸ Print RDP Login Info
      run: |
        Write-Output "ğŸ“¡ RDP Address: ${{ steps.ngrok.outputs.rdp }}"
        Write-Output "ğŸ‘¤ Username: runneradmin"
        Write-Output "ğŸ” Password: P@ssw0rd123"

    - name: ğŸ§  Anti-Idle - Keep Alive for 6 hours
      run: |
        for ($i = 0; $i -lt 21600; $i += 60) {
          Write-Output "â±ï¸ RDP session active for $i seconds..."
          Start-Sleep -Seconds 60
        }
